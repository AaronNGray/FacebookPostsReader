{"version":3,"sources":["PostsReader.js"],"names":["FB","require","fetch","_","PostsReader","constructor","options","api_version","user","access_token","limit","accumulator","next","timer","rate","delay","timeout","finished","console","log","error","fields","allFields","initialize","time","Date","getHours","getMinutes","getSeconds","join","response","_error","result","json","data","paging","_finished","length","setTimeout","bind","batch","code","concat","clearTimeout","module","exports"],"mappings":"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","file":"PostsReader.map","sourceRoot":"..\\lib","sourcesContent":["//\n//  Facebook.PostsReader\n//\n//    const facebook = require(\"./lib/facebook.js\");\n//    const fs = require(\"fs\");\n//\n//    postsReader = new facebook.PostsReader({\n//        access_token: req.session.access_token,\n//        finished: function(data) { fs.writeFileSync(__dirname + \"/timeline.json\", JSON.stringify(data)); }\n//    });\n//\n\nconst FB = require('fb');\nconst fetch = require('node-fetch');\nconst _ = require(\"underscore\");\n\nclass PostsReader {\n    constructor(options) {\n        this.api_version = options.api_version || \"v2.8\";\n        this.user = options.user || \"me\";\n        this.access_token = options.access_token;\n        this.limit = options.limit || 250;\n        this.accumulator = [];\n        this.next = null;\n        this.timer = null;\n        this.rate = options.rate * 1000 || 5 * 60 * 1000;\n        this.delay = options.delay * 1000 || 10 * 60 * 1000;\n        this.timeout = options.timeout * 1000 || 5 * 60 * 1000;\n\n        this.finished = options.finished || function() { console.log(\"finished()\"); }\n        this.error = options.error || function() { console.log(\"error()\"); }\n\n        this.fields = options.fields || allFields;\n    }\n\n    async initialize() {\n        console.log(\"PostsReader.prototype.initialize()\");\n        var time = new Date();\n        console.log(\"\", time.getHours(), \": \", time.getMinutes(), \": \", time.getSeconds());\n\n        this.next = \"https://graph.facebook.com/\" + this.api_version + \"/me/feed\" + \"?\" +\n            \"fields=\" + this.fields.join(',') + \"&\" +\n            \"limit=\" + this.limit + \"&\" +\n            \"access_token=\" + this.access_token\n        ;\n\n        var response = await fetch(this.next, {timeout: this.timeout} );\n\n        if (response.error)\n            return this._error(response.error);\n\n        var result = await response.json();\n\n        if (result.error || !result.data) {\n            return this._error(result.error, this.accumulator);\n        }\n\n        if (!result.paging.next) {\n            this._finished(this.accumulator);\n            return\n        }\n\n        console.log(\"result.data: \", result.data);\n        this.accumulator = result.data;\n        var time = new Date();\n        console.log(\"\", time.getHours(), \": \", time.getMinutes(), \": \", time.getSeconds(), \" - \",\"this.accumulator.length = \", this.accumulator.length);\n\n        this.next = result.paging.next;\n        console.log(\"result.paging.next: \", result.paging.next);\n\n        this.timer = setTimeout(_.bind(this.batch, this), this.rate);\n    }\n\n    async batch() {\n        //console.log(\"PostsReader.prototype.batch()\");\n\n        //console.log(\"this.next = \", this.next);\n\n        var response = await fetch(this.next, {timeout: this.timeout} );\n        var result = await response.json();\n\n        if (result.error && result.error.code == 1) {\n            do {\n                response = await fetch(this.next, {timeout: this.timeout} );\n                result = await response.json();\n            }\n            while (result.error && result.error.code == 1);\n        } else if (result.error && result.error.code == 4) {\n            this.timer = setTimeout(_.bind(this.batch, this), this.delay);\n            return\n        }\n\n        if (result.error || !result.data) {\n            return this._error(result.error, this.accumulator);\n        }\n\n        var time = new Date();\n        this.accumulator = this.accumulator.concat(result.data);\n        console.log(\"\", time.getHours(), \": \", time.getMinutes(), \": \", time.getSeconds(), \" - \",\"this.accumulator.length = \", this.accumulator.length);\n\n        if (result && result.data.length == 0) {\n            this._finished(this.accumulator);\n            return\n        }\n\n        if (result && !result.paging && !result.paging.next) {\n            this._finished(this.accumulator);\n            return\n        }\n\n        this.next = result.paging && result.paging.next;\n        console.log(\"result.paging: \", result.paging);\n        console.log(\"result.paging.next: \", result.paging && result.paging.next);\n\n        if (typeof this.next == \"string\") {\n            this.timer = setTimeout(_.bind(this.batch, this), this.rate);\n        }\n        else {\n            clearTimeout(this.timer);\n            this._finished(this.accumulator);\n        }\n    }\n\n    _finished(data) {\n        this.finished(data);\n    }\n    _error(error, data) {\n        this.error(error, data);\n    }\n\n    static allFields = [\n        'id',\n        'application',\n        'call_to_action',\n        'caption',\n        'comments',\n        'created_time',\n        'description',\n        'feed_targeting',\n        'from',\n        'icon',\n        //'instagram_eligibility',\n        'is_hidden',\n        //'is_instagram_eligible',\n        'is_published',\n        'likes',\n        'link',\n        'message',\n        //'message_tags',\n        'name',\n        'object_id',\n        'parent_id',\n        'permalink_url',\n        'picture',\n        'place',\n        'privacy',\n        'properties',\n        'shares',\n        'source',\n        'status_type',\n        'story',\n        'story_tags',\n        'targeting',\n        'to',\n        'type',\n        'updated_time',\n        //'with_tags'\n    ];\n\n};\n\nmodule.exports = PostsReader;\n"]}